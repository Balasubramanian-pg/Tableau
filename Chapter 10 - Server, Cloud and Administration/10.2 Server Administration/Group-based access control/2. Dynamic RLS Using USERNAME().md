# Standard Operating Procedure: Dynamic User-Based RLS

**Document ID:** TAB-SEC-002
**Topic:** Implementing Dynamic Row-Level Security via `USERNAME()`
**Objective:** Automatically restrict data based on the logged-in user's identity matching a column in the dataset.

## 1. Prerequisites & Scenario
**Scenario:** A Sales Commission Report.
*   **Data Field:** `[Account Owner Email]` (Values: 'j.doe@company.com', 's.smith@company.com').
*   **Requirement:**
    *   Users must only see rows where the `[Account Owner Email]` matches their Tableau login ID.
    *   Admins must see all rows.

## 2. Data Requirements
*Ensure your data source is formatted correctly before opening Tableau.*

1.  **Reference Column:** The dataset must contain a column (Dimension) that lists the User IDs or Emails exactly as they appear in Tableau Server/Cloud.
2.  **Normalization:** Ensure both the Tableau usernames and data values match in case (e.g., all lowercase).

## 3. Desktop Implementation
*Perform these steps in Tableau Desktop.*

### Step A: Verify User Function
1.  Open Tableau Desktop.
2.  Create a temporary calculation: `USERNAME()`.
3.  Drag it to the view to confirm if it returns just an ID (e.g., `jdoe`) or a full email (e.g., `jdoe@company.com`).
4.  *Ensure your data column matches this format.*

### Step B: Create the Security Logic
1.  Go to **Analysis** > **Create Calculated Field**.
2.  Name the field: `!User Security Filter`.
3.  Enter the following logic (choose the option that fits your needs):

**Option 1: Strict User Matching**
```tableau
// Returns TRUE only if the column matches the user
[Account Owner Email] = USERNAME()
```

**Option 2: User Matching + Admin Override (Recommended)**
```tableau
// 1. Allow Admins to see all
ISMEMBEROF('Tableau Administrators')

OR

// 2. Match specific user to the data row
[Account Owner Email] = USERNAME()
```

### Step C: Apply the Global Filter
1.  Navigate to a Worksheet.
2.  Drag the `!User Security Filter` field to the **Filters Shelf**.
3.  In the dialog box:
    *   If you are the Admin/Owner, you will see **True**. Select it.
    *   *Note: If you only see False, ensure your username exists in the data column or add the Admin logic above.*
4.  Click **OK**.
5.  Right-click the pill in the Filters Shelf and select **Apply to Worksheets** > **All Using This Data Source**.

## 4. Testing & Validation
1.  In the bottom right corner of Tableau Desktop, click the **Filter as User** icon.
2.  **Select a User:** Search for a specific sales representative (e.g., 's.smith').
3.  **Verify:** The dashboard should filter down to show *only* the rows where `[Account Owner Email]` equals 's.smith@company.com'.
4.  **Select an Admin:** Switch to an Admin user and verify they see all data (if using Option 2).

## 5. Deployment
1.  **Publish** the workbook to Tableau Server/Cloud.
2.  **Important:** Unlike Group RLS, you do not need to manage permissions on the Server side constantly. The security updates dynamically as soon as a user's name appears in the data source.
